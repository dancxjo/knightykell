ARG ROS_DISTRO=jazzy
FROM ubuntu:24.04 AS base

ENV DEBIAN_FRONTEND=noninteractive \
    TZ=Etc/UTC \
    ROS_DISTRO=${ROS_DISTRO} \
    RMW_IMPLEMENTATION=rmw_cyclonedds_cpp

# Core OS deps and tools
RUN apt-get update && apt-get install -y --no-install-recommends \
      curl gnupg lsb-release ca-certificates software-properties-common \
      locales tzdata git bash-completion ripgrep \
      python3 python3-pip python3-venv \
      build-essential \
    && rm -rf /var/lib/apt/lists/*

# Locales
RUN sed -i 's/# en_US.UTF-8/en_US.UTF-8/' /etc/locale.gen \
    && locale-gen en_US.UTF-8 \
    && update-locale LANG=en_US.UTF-8
ENV LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8

# ROS 2 apt repository + base install
RUN apt-get update && apt-get install -y --no-install-recommends \
      curl gnupg lsb-release \
    && rm -rf /var/lib/apt/lists/* \
    && curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key \
         | gpg --dearmor > /usr/share/keyrings/ros.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" \
         > /etc/apt/sources.list.d/ros2.list \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
         ros-${ROS_DISTRO}-ros-base \
         ros-${ROS_DISTRO}-rmw-cyclonedds-cpp \
         python3-colcon-common-extensions \
         python3-rosdep \
    && rm -rf /var/lib/apt/lists/*

# Initialize rosdep (safe if already initialized)
RUN rosdep init || true && rosdep update || true

# Create a default workspace
ENV ROS_WS=/opt/ros2_ws
RUN mkdir -p ${ROS_WS}/src

# Entry point that sources ROS and workspace overlays
RUN bash -lc 'cat > /ros_entrypoint.sh <<EOF\n#!/usr/bin/env bash\nset -e\nsource /opt/ros/${ROS_DISTRO}/setup.bash || true\nif [ -f \"${ROS_WS}/install/setup.bash\" ]; then\n  source \"${ROS_WS}/install/setup.bash\"\nfi\nexec \"$@\"\nEOF' \
 && chmod +x /ros_entrypoint.sh

WORKDIR /root
ENTRYPOINT ["/ros_entrypoint.sh"]
CMD ["bash"]

