FROM ros:jazzy-ros-base AS base
ARG ROS_DISTRO=jazzy

ENV DEBIAN_FRONTEND=noninteractive \
    TZ=Etc/UTC \
    ROS_DISTRO=${ROS_DISTRO} \
    RMW_IMPLEMENTATION=rmw_cyclonedds_cpp \
    LANG=en_US.UTF-8 \
    LC_ALL=en_US.UTF-8

# Core OS deps and tools + ROS dev utilities
RUN apt-get update && apt-get install -y --no-install-recommends \
      locales tzdata git bash-completion ripgrep \
      python3-pip python3-venv \
      build-essential \
      python3-colcon-common-extensions python3-rosdep \
      ros-${ROS_DISTRO}-rmw-cyclonedds-cpp \
    && rm -rf /var/lib/apt/lists/*

# Locales
RUN sed -i 's/# en_US.UTF-8/en_US.UTF-8/' /etc/locale.gen \
    && locale-gen en_US.UTF-8 \
    && update-locale LANG=en_US.UTF-8

# Initialize rosdep (safe if already initialized)
RUN rosdep init || true && rosdep update || true

# Create a default workspace
ENV ROS_WS=/opt/ros2_ws
RUN mkdir -p ${ROS_WS}/src

# Entry point that sources ROS and workspace overlays
RUN bash -lc 'cat > /ros_entrypoint.sh <<EOF\n#!/usr/bin/env bash\nset -e\nsource /opt/ros/${ROS_DISTRO}/setup.bash || true\nif [ -f \"${ROS_WS}/install/setup.bash\" ]; then\n  source \"${ROS_WS}/install/setup.bash\"\nfi\nexec \"$@\"\nEOF' \
 && chmod +x /ros_entrypoint.sh

WORKDIR /root
ENTRYPOINT ["/ros_entrypoint.sh"]
CMD ["bash"]
